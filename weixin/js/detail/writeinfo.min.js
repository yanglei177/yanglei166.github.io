 $(function(){
	 //授权密钥
	 //非微信  底部改为 请登录
	if(baopRequest.is_weixin()){
		var targetUrl = window.location.href;
		$.ajax({
			url:SERVER_URL + '/weixin/wxapi/initConfig.html',
			data:{debug:false,url:targetUrl},
			dataType: 'json',
			success:function(data){alert("授权成功")
				wx.config(data);
				wx.error(function(res){
					alert(JSON.stringify(res));
					//alert("----");
				});
			},
			error: function(xhr, type){
				alert("----");
			}       		
		}); 
	}
	 //init
	 // change submit value;
	if(localStorage.getItem("agent_price") && localStorage.getItem("paymentType") == 1){
		$(".paybtn").val("微信支付(￥" + localStorage.getItem("agent_price") + ")");
	}else if(localStorage.getItem("paymentType") == 0){
		$("#orderbtn").val("提交");
	} 	 
	 if(localStorage.getItem("insurantName")){
		 $("input[name=insurantName]").val(localStorage.getItem("insurantName"));
	 }
	 if(localStorage.getItem("identificationNo")){
		 $("input[name=identificationNo]").val(localStorage.getItem("identificationNo"));
	 }
	 if(localStorage.getItem("carOwnerName")){
		 $("input[name=carOwnerName]").val(localStorage.getItem("carOwnerName"));
	 }
	 if(localStorage.getItem("carOwnerIdentification")){
		 $("input[name=carOwnerIdentification]").val(localStorage.getItem("carOwnerIdentification"));
	 }
	 
	 
	 if(localStorage.getItem("path_w1")){
		var imgdata1 = JSON.parse(localStorage.getItem("path_w1"));
		$(".img_box").eq(0).find("ul").append("<li id=" + imgdata1.url + "><img src='" + imgdata1.path + "' ><span class='clo'>x</span></li>"); 
	}	
	if(localStorage.getItem("path_w2")){
		var imgdata2 = JSON.parse(localStorage.getItem("path_w2"));
		$(".img_box").eq(1).find("ul").append("<li id=" + imgdata2.url + "><img src='" + imgdata2.path + "' ><span class='clo'>x</span></li>"); 
	}
	if(localStorage.getItem("path_w3")){
		var imgdata3 = JSON.parse(localStorage.getItem("path_w3"));
		$(".img_box").eq(2).find("ul").append("<li id=" + imgdata3.url + "><img src='" + imgdata3.path + "' ><span class='clo'>x</span></li>"); 
	}	
	if(localStorage.getItem("path_w4")){
		var imgdata4 = JSON.parse(localStorage.getItem("path_w4"));
		$(".img_box").eq(3).find("ul").append("<li id=" + imgdata4.url + "><img src='" + imgdata4.path + "' ><span class='clo'>x</span></li>"); 
	}	
	$(".img_box img").on("load",function(){
		  var w = $(this).width(),
			  h = $(this).height();
		  if(h>w){
			 $(this).css({"width":"h/89*w"+"px","height":"89px"}); 
		  }
	  }); 
	  
	  $(".text,.area").blur(function(){
		 if(!$(this).hasClass("error") && ($.trim($(this).val())) != "") {
			 localStorage.setItem($(this).attr("name"),$(this).val());
		 }
	  });
	 	 
	 var isCarOwner = "1", totalData = "&quationId=" + localStorage.getItem("quationId");
	 if(localStorage.getItem("isCarOwner")){
		 isCarOwner = "0";
	 }else{
		 isCarOwner = "1";
	 }
	 //localStorage.setItem("isCarOwner",isCarOwner);
	 if(localStorage.getItem("path_w1")){
		 totalData += "&identificationImgFront=" + JSON.parse(localStorage.getItem("path_w1")).url;
	 }
	 if(localStorage.getItem("path_w2")){
		  totalData += "&identificationImgBack=" + JSON.parse(localStorage.getItem("path_w2")).url;
	 }
	 var uid = localStorage.getItem("uid");
	 if(localStorage.getItem("wid")){
		var wid = localStorage.getItem("wid");
	}
	 if(localStorage.getItem("isCarOwner")){
		 $(".orbtn").removeClass("on");
		 $("#carowner").show();		 
	 }
	 $(".orbtn").click(function(){
		 if($(this).hasClass("on")){
			 isCarOwner = "1";
		 	$("#carowner").slideUp(400);
			localStorage.removeItem("isCarOwner");			 	
		 }else{
			 isCarOwner = "0";
			 $("#carowner").slideDown(400);
		     localStorage.setItem("isCarOwner",isCarOwner);			
		 }
	 });
	 
	if(localStorage.getItem("path_w3")){
		totalData += "&carOwnerImgFront=" + JSON.parse(localStorage.getItem("path_w3")).url;
	}
	if(localStorage.getItem("path_w4")){
		totalData += "&carOwnerImgBack=" + JSON.parse(localStorage.getItem("path_w4")).url;
	} 
	 
	 totalData += "&addressee=" + localStorage.getItem("ad_name") + "&address=" + localStorage.getItem("ad_adress") + "&zipCode=" + localStorage.getItem("postcode") + "&receiptPhone=" +	localStorage.getItem("ad_tel"); 	 	 
	 // 个人 or 公司
	$(".simulateradio").click(function(){
		 var index = $(".simulateradio").index(this);
		 $(this).find("i").addClass("on").end().siblings(".simulateradio").find("i").removeClass("on");
		 if(index == 0){
			 $(this).parent("li").siblings().slideUp(400);
			 totalData += "&receiptType=0";
		 }else{
			 $(this).parent("li").siblings().slideDown(400);
			 totalData += "&receiptType=1";
		 }
	 });
	 
	$("#inputForm").validate({
		rules: {
			insurantName: {
				required: true
			},
			identificationNo: {
				required: true,
				isCardNo: true
			},
			carOwnerName: {
				required: true
			},
			carOwnerIdentification: {
				required: true
			},			
			receiptContent: {
				required: true				
			}
		},
		messages: {
			insurantName: {
				required: "请输入被保人姓名"
			},
			identificationNo:  {
				required: "请输入身份证号码",
				isCardNo: "请输入正确身份证号码"
			},			
			carOwnerName: {
				required: "请输入车主姓名"
			},
			carOwnerIdentification: {
				required: "请输入身份证号码"
			},
			receiptContent: {
				required: "请输入发票抬头"
			}
		},
		submitHandler:function(form){				
			if(!localStorage.getItem("path_w1")){
				baopRequest.bp_alert("请上传被保险人身份证正面",2000); return;
			}
			if(!localStorage.getItem("path_w2")){
				baopRequest.bp_alert("请上传被保险人身份证反面",2000); return;
			}
			if(isCarOwner == 0){
				if(!localStorage.getItem("path_w3")){
					baopRequest.bp_alert("请上传车主身份证正面",2000); return;
				}
				if(!localStorage.getItem("path_w4")){
					baopRequest.bp_alert("请上传车主身份证反面",2000); return;
				}
			}
			if(!$(".adress_box").is(":visible")){
				baopRequest.bp_alert("请选择收件地址",2000); return;
			}			
            var reqData = $(form).serialize() + totalData + "&isCarOwner=" + isCarOwner;	console.log(data)	
            baopRequest.sendData("order/create", reqData, function(data){
				if (data.code == 0) {
					localStorage.setItem("orderId",data.id);
					if(localStorage.getItem("paymentType") == 0){
						location.href="offline.html";
					}else{alert(localStorage.getItem("orderId"))
						wx.ready(function(){
							var payData = {
									orderId:localStorage.getItem("orderId"),
									openid: localStorage.getItem("wid")
							};
							baopRequest.sendData(SERVER_URL + "/baoping-wxpay/api/wechat/generatePrePayOrder", payData, function(paydata){
								if (paydata.code == 0) {
									wx.chooseWXPay({
										timestamp:paydata.timeStamp,
										nonceStr:paydata.nonceStr, 
										package:paydata.package, 
										signType:paydata.signType,
										paySign:paydata.paySign,
										success:function (res) {
											alert(res);
										}
									});
								}baopRequest.bp_alert(paydata.message,2000);
							})
							
						})
					}	
					localStorage.clear();
					localStorage.setItem("uid",uid);
					if(wid){
						localStorage.setItem("wid",wid);
					}														
				}else{
                    baopRequest.bp_alert(data.message,2000);
                }
			});
		}
	});	
	
	
	//add adress
	$(".titbtn").click(function(){
		location.href = "addr_list.html?url=writeinfo";
	});
	if(baopRequest.getURLParam("url") == "writeinfo"){
		$(".titbtn").val("选择收件地址");
		$(".adress_box").show();
		$(".ad_name").html(localStorage.getItem("ad_name"));
		$(".ad_tel").html(localStorage.getItem("ad_tel"));
		$(".ad_adress").html(localStorage.getItem("ad_adress"));
		$(".postcode").html(localStorage.getItem("postcode"));
		
	}		
		
 });
 
 //upload images
 //var imgpath = "http://test.ebaoping.com/data/image/";
 $('.fileimg').eq(0).UploadImg({	 
     url : API_URL_ROOT +'upload/uploadImg',
     width : '640',
     //height : '300',
     quality : '0.8', //压缩率，默认值为0.8
     // 如果quality是1 宽和高都未设定 则上传原图
     mixsize : '6',
     bussinessType:'2',
     pictureCount:'4',
     type : [".jpg", ".png", ".JPG", ".PNG",".bmp",".jpeg"],
     before : function(blob,pcUrl){		 
         pictureName=pcUrl;
          var html = "<li id=" + pcUrl + "><img src='" + blob + "' ><span class='clo'>x</span></li>";		  
          $(".img_box").eq(0).find("ul").append(html);
		  $(".img_box img").on("load",function(){
			  var w = $(this).width(),
				  h = $(this).height();
			  if(h>w){
				 $(this).css({"width":"h/89*w"+"px","height":"89px"}); 
			  }
		  });       
     },
     error : function(res){
         $('#error').html(res);
		 baopRequest.bp_alert("行驶证正本图片上传失败，请重新选择上传。",2000);
     },
     success : function(res){	 		 		 
		 var imgjson = {};
		 imgjson.url = res.url;
		 imgjson.path = IMG_PATH_ROOT + res.url;		 		 
		 localStorage.setItem("path_w1",JSON.stringify(imgjson));
     }
 });

 $('.fileimg').eq(1).UploadImg({	 
     url : API_URL_ROOT +'upload/uploadImg',
     width : '640',
     //height : '300',
     quality : '0.8', //压缩率，默认值为0.8
     // 如果quality是1 宽和高都未设定 则上传原图
     bussinessType:'2',
     mixsize : '6',
     pictureCount:'4',
     type : [".jpg", ".png", ".JPG", ".PNG",".bmp",".jpeg"],
     before : function(blob,pcUrl){		 
         pictureName=pcUrl;
          var html = "<li id=" + pcUrl + "><img src='" + blob + "' ><span class='clo'>x</span></li>"
          $(".img_box").eq(1).find("ul").append(html); 
		  $(".img_box img").on("load",function(){
			  var w = $(this).width(),
				  h = $(this).height();
			  if(h>w){
				 $(this).css({"width":"h/89*w"+"px","height":"89px"}); 
			  }
		  });         
     },
     error : function(res){
         $('#error').html(res);
		 baopRequest.bp_alert("行驶证正本图片上传失败，请重新选择上传。",2000);
     },
     success : function(res){
		 var imgjson = {};
		 imgjson.url = res.url;
		 imgjson.path = IMG_PATH_ROOT + res.url;		 		 
		 localStorage.setItem("path_w2",JSON.stringify(imgjson));
     }
 });
  $('.fileimg').eq(2).UploadImg({	 
     url : API_URL_ROOT +'upload/uploadImg',
     width : '640',
     //height : '300',
     quality : '0.8', //压缩率，默认值为0.8
     // 如果quality是1 宽和高都未设定 则上传原图
     bussinessType:'2',
     mixsize : '6',
     pictureCount:'4',
     type : [".jpg", ".png", ".JPG", ".PNG",".bmp",".jpeg"],
     before : function(blob,pcUrl){		 
         pictureName=pcUrl;
          var html = "<li id=" + pcUrl + "><img src='" + blob + "' ><span class='clo'>x</span></li>"
          $(".img_box").eq(2).find("ul").append(html); 
		  $(".img_box img").on("load",function(){
			  var w = $(this).width(),
				  h = $(this).height();
			  if(h>w){
				 $(this).css({"width":"h/89*w"+"px","height":"89px"}); 
			  }
		  });         
     },
     error : function(res){
         $('#error').html(res);
		 baopRequest.bp_alert("行驶证正本图片上传失败，请重新选择上传。",2000);
     },
     success : function(res){
		 var imgjson = {};
		 imgjson.url = res.url;
		 imgjson.path = IMG_PATH_ROOT + res.url;		 		 
		 localStorage.setItem("path_w3",JSON.stringify(imgjson));
     }
 });
  $('.fileimg').eq(3).UploadImg({	 
     url : API_URL_ROOT +'upload/uploadImg',
     width : '640',
     //height : '300',
     quality : '0.8', //压缩率，默认值为0.8
     // 如果quality是1 宽和高都未设定 则上传原图
     bussinessType:'2',
     mixsize : '6',
     pictureCount:'4',
     type : [".jpg", ".png", ".JPG", ".PNG",".bmp",".jpeg"],
     before : function(blob,pcUrl){		 
         pictureName=pcUrl;
          var html = "<li id=" + pcUrl + "><img src='" + blob + "' ><span class='clo'>x</span></li>"
          $(".img_box").eq(3).find("ul").append(html); 
		  $(".img_box img").on("load",function(){
			  var w = $(this).width(),
				  h = $(this).height();
			  if(h>w){
				 $(this).css({"width":"h/89*w"+"px","height":"89px"}); 
			  }
		  });         
     },
     error : function(res){
         $('#error').html(res);
		 baopRequest.bp_alert("行驶证正本图片上传失败，请重新选择上传。",2000);
     },
     success : function(res){
		 var imgjson = {};
		 imgjson.url = res.url;
		 imgjson.path = IMG_PATH_ROOT + res.url;		 		 
		 localStorage.setItem("path_w4",JSON.stringify(imgjson));
     }
 });

$(document).delegate("span.clo", "click", function() {
	$(this).parent("li").remove();	
});